#!/usr/bin/env perl
use strict;
use warnings;

use MYDan;
use File::Basename;
use MYDan::Util::Sudo;
use MYDan::Util::OptConf;
use Digest::MD5;

use MYDan::Bootstrap;
MYDan::Util::Sudo->sudo();

$| ++;

$MYDan::Util::OptConf::THIS = 'bootstrap';

=head1 SYNOPSIS

 $0 --install

 $0 --uninstall  
         ( uninstall: Not recommended )

 $0 --reload
 $0 --run
    
=cut

my %o = MYDan::Util::OptConf->load()->get( qw( install uninstall run reload ) )->dump();

my $bootstrap = MYDan::Bootstrap->new( %o );

my $uuid = substr Digest::MD5->new->add( $ENV{MYDanPATH} = $MYDan::PATH )->hexdigest, 0, 7;

if( $o{reload} )
{
    for my $name ( map{  $_ =~ /\*/ ? ( map{ basename $_ }glob "$o{lock}/$_" ): "$_.lock"} @ARGV ? @ARGV : ( '*' ) )
    {
        next unless $name =~ s/\.lock$//g;
        printf "$name: %s\n", $bootstrap->kill( $name, 'TERM' ) ? "kill" : "undo";
    }
}
elsif( $o{install} )
{
    my $rs = "$MYDan::PATH/var/ReservedSpace";
    system( "mkdir -p '$rs'" ) unless -d $rs;
    map{ system( "echo ReservedSpace > '$rs/$_'" ) unless -f "$rs/$_"; } 1..100;

    system "echo '* * * * * root $MYDan::PATH/dan/bootstrap/bin/bootstrap --run' > /etc/cron.d/mydan_bootstrap_cron_$uuid";
}
elsif( $o{uninstall} )
{
    unlink "/etc/cron.d/mydan_bootstrap_cron_$uuid";
    system "killall $uuid.mydan.bootstrap.master";
}
elsif( $o{run} )
{
    $bootstrap->run();
}
